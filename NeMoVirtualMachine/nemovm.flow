import runtime;
import lingo/pegcode/driver;

export{
    VMProgram(declarations : [VMVariable], instructions : [VMInstruction]);

    VMInstruction(label : int, body : VMBody);

    VMBody ::= VMAssign, VMTest, VMPrint;
    VMAssign(var: string, value: VMExpression, goto : [int]);                 ///var := expr
    VMTest(operation: string, l: VMExpression, r: VMExpression, iflabel : [int], elselabel : [int]);  ///(body)?
    VMPrint(expr: VMExpression, goto : [int]);                                ///print(expr)

    VMVariable(name : string, type : VMType);

    VMType ::= VMInt, VMArray;
    VMInt();
    VMArray(type : VMType);

    VMExpression ::= VMMathOpExpr, VMArSetValExpr, VMArGetValExpr, VMArLenExpr, VMVarExpr, VMIntExpr;
    VMMathOpExpr(operation: string, l: VMExpression, r: VMExpression);
    VMArSetValExpr(array: VMVarExpr, index: VMExpression, value: VMExpression);
    VMArGetValExpr(array: VMVarExpr, index: VMExpression);
    VMArLenExpr(array: VMVarExpr);
    VMVarExpr(name: string);
    VMIntExpr(value: int);

    vmstr2vmprogram(program : string) -> Maybe<VMProgram>;
}

makeLabelsArray(labels: [flow]) -> [int]{
    concat([labels[0]], labels[1]);
}

makeMinusInt(bodies: [flow]) -> VMIntExpr{
    val = bodies[0];
    VMIntExpr(val*(-1));
}

vmstr2vmprogram(program : string) -> Maybe<VMProgram> {
    treeLabels = setTree(defaultPegActions.t, "makeLabelsArray", makeLabelsArray);
    fullThree = setTree(treeLabels, "makeMinusInt", makeMinusInt);
    pegActions = SemanticActions(fullThree);
    grammar = "#include NeMoVirtualMachine/nemovm.lingo";
    ret = parsic3(compilePegGrammar(grammar), program, pegActions, VMProgram([],[VMInstruction(0,VMPrint(VMIntExpr(0),[]))]));
    if(ret.third==""){
        Some(ret.first);
    }else{
        None();
    }
}

